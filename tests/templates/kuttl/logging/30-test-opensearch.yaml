---
apiVersion: batch/v1
kind: Job
metadata:
  name: test-log-aggregation
spec:
  template:
    spec:
      containers:
        - name: test-log-aggregation
          image: oci.stackable.tech/sdp/testing-tools:0.3.0-stackable0.0.0-dev
          command:
            - python
          args:
            - scripts/test.py
          volumeMounts:
            - name: script
              mountPath: /stackable/scripts
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL
            runAsNonRoot: true
          resources:
            requests:
              memory: 128Mi
              cpu: 100m
            limits:
              memory: 128Mi
              cpu: 400m
      volumes:
        - name: script
          configMap:
            name: test-log-aggregation
      serviceAccountName: test-service-account
      securityContext:
        fsGroup: 1000
      restartPolicy: OnFailure
    backoffLimit: 10
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: test-log-aggregation
data:
  test.py: |
    import requests


    def check_sent_events():
        response = requests.post(
            'http://opensearch-vector-aggregator:8686/graphql',
            json={
                'query': """
                    {
                        transforms(first:100) {
                            nodes {
                                componentId
                                metrics {
                                    sentEventsTotal {
                                        sentEventsTotal
                                    }
                                }
                            }
                        }
                    }
                """
            }
        )

        assert response.status_code == 200, \
            'Cannot access the API of the vector aggregator.'

        result = response.json()

        transforms = result['data']['transforms']['nodes']
        for transform in transforms:
            sentEvents = transform['metrics']['sentEventsTotal']
            componentId = transform['componentId']

            if componentId == 'filteredInvalidEvents':
                assert sentEvents is None or \
                       sentEvents['sentEventsTotal'] == 0, \
                       'Invalid log events were sent.'
            else:
                assert sentEvents is not None and \
                       sentEvents['sentEventsTotal'] > 0, \
                       f'No events were sent in "{componentId}".'


    def check_log_file_rollover():
        response = requests.post(
            'http://opensearch-nodes-automatic-vector:8686/graphql',
            json={
                'query': """
                    {
                        sources {
                            nodes {
                                componentId
                                metrics {
                                    receivedBytesTotal {
                                        receivedBytesTotal
                                    }
                                }
                            }
                        }
                    }
                """
            }
        )

        assert response.status_code == 200, \
            'Cannot access the API of the vector agent.'

        result = response.json()

        sources = result['data']['sources']['nodes']
        for source in sources:
            receivedBytes = source['metrics']['receivedBytesTotal']
            componentId = source['componentId']

            if componentId == 'files_opensearch_server':
                assert receivedBytes is not None
                receivedBytes = receivedBytes['receivedBytesTotal']
                MAX_LOG_FILE_SIZE = 5_500_000
                expectedBytes = 2 * MAX_LOG_FILE_SIZE
                assert receivedBytes >= expectedBytes, \
                       'Log file rollover did not yet happen twice ' \
                       f'({receivedBytes:,.0f} Bytes of {expectedBytes:,d} Bytes received). ' \
                       'The first rollover requires write permission to rename the log file, ' \
                       'the second rollover additionally requires delete permission to remove the old log file.'


    if __name__ == '__main__':
        check_sent_events()
        check_log_file_rollover()
        print('Test successful!')
