---
apiVersion: batch/v1
kind: Job
metadata:
  name: test-updated-security-config
spec:
  template:
    spec:
      containers:
        - name: test-updated-security-config
          image: oci.stackable.tech/sdp/testing-tools:0.3.0-stackable0.0.0-dev
          command:
            - /bin/bash
            - -euxo
            - pipefail
            - -c
          args:
            - |
              pip install opensearch-py==3.1.0
              python scripts/test.py
          env:
            # required for pip install
            - name: HOME
              value: /stackable
          envFrom:
            - configMapRef:
                name: opensearch
          volumeMounts:
            - name: script
              mountPath: /stackable/scripts
            - name: tls
              mountPath: /stackable/tls
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL
            runAsNonRoot: true
          resources:
            requests:
              memory: 128Mi
              cpu: 100m
            limits:
              memory: 128Mi
              cpu: 400m
      volumes:
        - name: script
          configMap:
            name: test-updated-security-config
        - name: tls
          configMap:
            name: truststore-pem
      serviceAccountName: test-service-account
      securityContext:
        fsGroup: 1000
      restartPolicy: OnFailure
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: test-updated-security-config
data:
  test.py: |
    import os
    from opensearchpy import OpenSearch
    from opensearchpy.exceptions import AuthenticationException

    host = os.environ['OPENSEARCH_HOSTNAME']
    port = os.environ['OPENSEARCH_PORT']
    http_use_tls = os.environ['OPENSEARCH_PROTOCOL'] == 'https'

    connection_params = {
      'hosts': [{'host': host, 'port': port}],
      'http_compress': True,
      'use_ssl': http_use_tls,
      'verify_certs': True,
      'ca_certs': '/stackable/tls/ca.crt',
    }

    admin_client = OpenSearch(
      http_auth=('admin', 'AJVFsGJBbpT6mChn'),
      **connection_params
    )

    security_configuration = admin_client.security.get_configuration()
    assert security_configuration['config']['dynamic']['http']['anonymous_auth_enabled'] == False

    anonymous_client = OpenSearch(
      **connection_params
    )

    try:
      anonymous_client.info()
      assert False, "Anonymous authentication should be disabled."
    except AuthenticationException as e:
      assert e.status_code == 401
