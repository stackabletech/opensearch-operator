---
apiVersion: kuttl.dev/v1beta1
kind: TestStep
commands:
  - script: |
      PROMETHEUS_HELM_RELEASE_NAME=prometheus-$NAMESPACE
      PROMETHEUS_HELM_CHART_NAME=kube-prometheus-stack

      # `kube-prometheus-stack.fullname` in the Prometheus Helm Chart is used to create the
      # ServiceAccount names. It is set to `<.Release.Name>-<.Chart.Name>` and  truncated to
      # 26 characters, see
      # https://github.com/prometheus-community/helm-charts/blob/kube-prometheus-stack-81.2.2/charts/kube-prometheus-stack/templates/_helpers.tpl#L22
      KUBE_PROMETHEUS_STACK_FULLNAME=$PROMETHEUS_HELM_RELEASE_NAME-$PROMETHEUS_HELM_CHART_NAME
      export KUBE_PROMETHEUS_STACK_FULLNAME=${KUBE_PROMETHEUS_STACK_FULLNAME:0:26}

      envsubst '$KUBE_PROMETHEUS_STACK_FULLNAME' < 01_rbac.yaml | \
        kubectl apply --namespace=$NAMESPACE --filename=-
