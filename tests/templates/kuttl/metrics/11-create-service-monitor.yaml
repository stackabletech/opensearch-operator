---
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: stackable-opensearch
  labels:
    release: prometheus-stack
spec:
  selector:
    matchLabels:
      prometheus.io/scrape: "true"
  endpoints:
    - relabelings:
        - sourceLabels:
            - __meta_kubernetes_service_annotation_prometheus_io_scheme
          action: replace
          targetLabel: __scheme__
          regex: (https?)
        - sourceLabels:
            - __meta_kubernetes_service_annotation_prometheus_io_path
          action: replace
          targetLabel: __metrics_path__
          regex: (.+)
        # Use the FQDN instead of the IP address because the IP address
        # is not contained in the certificate.
        - sourceLabels:
            - __meta_kubernetes_pod_name
            - __meta_kubernetes_service_name
            - __meta_kubernetes_namespace
            - __meta_kubernetes_service_annotation_prometheus_io_port
          action: replace
          targetLabel: __address__
          regex: (.+);(.+);(.+);(\d+)
          replacement: $1.$2.$3.svc.cluster.local:$4
      tlsConfig:
        ca:
          configMap:
            name: truststore
            key: ca.crt
---
apiVersion: secrets.stackable.tech/v1alpha1
kind: TrustStore
metadata:
  name: truststore
spec:
  secretClassName: tls
  format: tls-pem
