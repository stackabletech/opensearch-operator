apiVersion: kuttl.dev/v1beta1
kind: TestStep
commands:
  - script: kubectl create cm test-opensearch-dashboards -n $NAMESPACE --from-file=test.py
---
apiVersion: batch/v1
kind: Job
metadata:
  name: test-opensearch-dashboards
spec:
  template:
    spec:
      containers:
        - name: test-opensearch-dashboards
          image: oci.stackable.tech/sdp/testing-tools:0.2.0-stackable0.0.0-dev
          command:
            - python
          args:
            - scripts/test.py
          env:
            - name: NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
            - name: OPENSEARCH_USER
              value: admin
            - name: OPENSEARCH_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: opensearch-credentials
                  key: admin
          volumeMounts:
            - name: script
              mountPath: /stackable/scripts
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL
            runAsNonRoot: true
          resources:
            requests:
              memory: 128Mi
              cpu: 100m
            limits:
              memory: 128Mi
              cpu: 400m
      volumes:
        - name: script
          configMap:
            name: test-opensearch-dashboards
      serviceAccountName: test-service-account
      securityContext:
        fsGroup: 1000
      restartPolicy: OnFailure
